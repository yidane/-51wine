<!DOCTYPE html>
<html>
<head>
    <title>地图导览</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta charset="utf-8"/>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-1.0.0-b1/leaflet.css" />
 

    <link href="//cdn.bootcss.com/font-awesome/4.4.0/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="css/L.Control.Locate.min.css" />
    <!--[if lt IE 9]>
    <link rel="stylesheet" href="css/L.Control.Locate.ie.min.css"/>
    <![endif]-->
    <style type="text/css">
        * {
            margin: 0;
            outline: 0;
            padding: 0;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }



        ul, li {
            list-style: none;
        }

        a {
            text-decoration: none;
        }

        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: 'Microsoft Yahei',Tahoma,Helvetica,Arial,sans-serif;
            font-size: 62.5%;
            position: relative;
        }



        .tip .leaflet-popup-content
        {
            margin: 0;
        }

        .tip-title {
            position: relative;
            height: 30px;
            line-height: 30px;
            border-bottom: 1px solid #E5E5E5;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .tip-title h3 {
            float: left;
            height: 30px;
            color: #1d9d74;
            line-height: 30px;
            padding-left: 10px;
            font-weight: normal;
            font-size: 16px;
            text-shadow: 0 1px 1px #FFF;
            font-weight: bold;
        }

        .tip-title .close {
            position: absolute;
            right: 5px;
            top: 8px;
            width: 13px;
            height: 13px;
            background: url(images/close.png) 0 0 no-repeat;
        }

        .tip-content {
            padding: 15px;
            font-size: 14px;
        }

        .tip-bottom {
            height: 35px;
            width: 100%;
            border-top: 1px solid #E5E5E5;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .tip-bottom ul {
            width: 100%;
        }

        .tip-bottom ul li {
            float: left;
            width: 50%;
            height: 35px;
            line-height: 35px;
            text-align: center;
            font-size: 14px;
            box-sizing: border-box;
            background: #e4e4e4;
        }


        .tip-bottom ul li:first-child {
            border-right: 1px solid rgba(0, 0, 0, 0.15);
        }

        .tip-bottom ul li a{
            color: #2c3e50;
        }

        .triangle {
            width: 0;
            height: 0;
            left: 50%;
            bottom: -8px;
            margin-left: -8px;
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: #fff transparent transparent;
            position: absolute;
        }

        .leaflet-popup-tip.has_point_detail {
            background: #e4e4e4;
        }

        .leaflet-popup-content-wrapper
        {
            padding: 0;
        }
/*定位消息提示*/
        .map_location_status {
            position: absolute;
            z-index: 1000;
            left: 0;
            right: 0;
            top: 50%;
            margin: -7.1875rem auto 0;
            width: 15.2em;
            height: 7.1875rem;
            text-align: center;
            background: #e9e9e9;
            color: #000;
            border-radius: .375rem;
            font-size: .9375rem;
        }
        .map_location_status_text {
            display: table-cell;
            text-align: center;
            vertical-align: middle;
            line-height: 1.4375rem;
            height: 2.875rem;
            padding: .78125rem 1.5625rem;
        }
        .map_location_status_ok {
            line-height: 2.5625rem;
            font-size: 1.125rem;
            color: #f38221;
            border-top: 1px solid #d4d4d4;
            text-align: center;
        }

        /*菜单*/
        .atfront{
            z-index: 1000;
        }
        .form-grouping
        {
        bottom: 0;
        position: fixed;
        width: 100%;
        left: 0;
        }
        .menu_acitve .form-grouping
        {
        height: 5rem;
        }
        .map_nav_bar_v2 {
            position: absolute;
            /*z-index: 1;*/
            height: 2.8125rem;
            /* left: 0; */
            right: 0;
            bottom: 0rem;
            width: 50px;
            float: right;
        }

        .map_nav_bar_v2 .map_nav_item_03 {
            right: .5rem;
            background-image: url("images/ico_general_map_04@2x.png?v=2014050901");
        }

        .menu_acitve .map_nav_bar_v2 {
            bottom: 8.7rem;
        }

        .menu_acitve .map_nav_item_03:after {
            -webkit-transform: rotate(180deg) translateY(2px);
            transform: rotate(180deg) translateY(2px);
        }

        .map_nav_bar_v2 .map_nav_item_03:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            width: 1.3125rem;
            height: .8125rem;
            background-image: url("images/ico_general_map_05@2x.png?v=2014050901");
            background-size: 100% auto;
        }

        .map_nav_bar_v2 .map_nav_item_01, .map_nav_bar_v2 .map_nav_item_02, .map_nav_bar_v2 .map_nav_item_03, .map_nav_bar_v2 .map_nav_item_04 {
            position: absolute;
            top: .125rem;
            width: 2.5625rem;
            height: 2.5625rem;
            background-size: 100% auto;
        }

        .menu_acitve .map_menu_containner {
            display: block;
        }
        .map_menu_containner {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            margin: auto;
            background: #34475a;
            -webkit-box-shadow: 0 0 5px #181b1e;
            box-shadow: 0 0 5px #181b1e;
            border-radius: .25rem;
            overflow: hidden;
            display: none;
        }
        .cf {
            zoom: 1;
        }

        .map_menu_ico {
            position: relative;
            z-index: 1;
            width: 20%;
            height: 4.0625rem;
            float: left;
            color: #ADC6E2;
            text-shadow: 0 1px 0 rgba(0,0,0,0.4);
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            padding-top: 2.5rem;
            line-height: 1.25rem;
            font-size: .625rem;
            text-align: center;
            -webkit-box-shadow: 1px 1px 0 #181b1e,2px 2px 0 #526273;
            box-shadow: 1px 1px 0 #181b1e,2px 2px 0 #526273;
        }
        .map_menu_ico i {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            width: 4rem;
            height: 4rem;
            margin: auto;

        }

        .map_menu_ico.disabled,.map_menu_ico.disabled i  {
            color: #52677C;
        }

        .poi-img {
            display: block;
            margin: 0 auto;
            width: 64px;
            height: 64px;
            border-radius: 64px;
            font-size: 24px;
            line-height: 64px;
            /*color: #1E2934;*/
            text-align: center;
        }

    </style>
    <style>

        #map {
            height: 100%;
            width: 100%;
        }
    </style>


</head>

<body>
<p id="txtlatlng"></p>
<div id="map"></div>
<div class="map_location_status" data-bind="visible :statusbox.show" style="display: none;">
    <div class="map_location_status_text" data-bind="text:statusbox.text"></div>
    <div class="map_location_status_ok" data-bind="click:statusbox.close">确 定</div>
</div>
<div class="form-grouping atfront " data-bind="css:{menu_acitve:pointMenu.show}" >
<div class="map_nav_bar_v2">

    <div class="map_nav_item_03" data-bind="click:togglemenu"></div>

</div>
    <div class="map_menu_containner cf"  data-bind="visible:pointMenu.show">
        <a class="map_menu_ico active" data-bind="css:{'active': pointMenu.activeType() == 'spot','disabled': !pointMenu.isEnabled.spot()},click:pointMenu.showTag.bind($data,'spot')" href="javascript:;" ><i class="poi-img fa fa-tree fa-2x"></i>景点</a>
        <a class="map_menu_ico" data-bind="css:{'active': pointMenu.activeType() == 'eat','disabled': !pointMenu.isEnabled.eat()},click:pointMenu.showTag.bind($data,'eat')" href="javascript:;" ><i class="poi-img fa fa-cutlery fa-2x"></i>美食</a>
        <a class="map_menu_ico" data-bind="css:{'active': pointMenu.activeType() == 'hotel','disabled': !pointMenu.isEnabled.hotel()},click:pointMenu.showTag.bind($data,'hotel')" href="javascript:;" ><i class="poi-img fa fa-hotel fa-2x"></i>酒店</a>
        <a class="map_menu_ico" data-bind="css:{'active': pointMenu.activeType() == 'wc','disabled': !pointMenu.isEnabled.wc()},click:pointMenu.showTag.bind($data,'wc')" href="javascript:;" ><i class="poi-img fa fa-male fa-2x"></i>洗手间</a>
        <a class="map_menu_ico" data-bind="css:{'active': pointMenu.activeType() == 'shop','disabled': !pointMenu.isEnabled.shop()},click:pointMenu.showTag.bind($data,'shop')" href="javascript:;" ><i class="poi-img fa fa-car fa-2x"></i>停车场</a>
        <a class="map_menu_ico" data-bind="css:{'active': pointMenu.activeType() == 'show','disabled': !pointMenu.isEnabled.show()},click:pointMenu.showTag.bind($data,'show')" href="javascript:;"  ><i class="poi-img fa fa-university fa-2x"></i>游牧点</a>
        <a class="map_menu_ico" data-bind="css:{'active': pointMenu.activeType() == 'help','disabled': !pointMenu.isEnabled.help()},click:pointMenu.showTag.bind($data,'help')" href="javascript:;"  ><i class="poi-img fa fa-road fa-2x"></i>栈道</a>
        <a class="map_menu_ico " data-bind="css:{'active': pointMenu.activeType() == 'wifi','disabled': !pointMenu.isEnabled.wifi()},click:pointMenu.showTag.bind($data,'wifi')" href="javascript:;"><i class="poi-img fa fa-home fa-2x"></i>定居点</a>

    <!--<a class="map_menu_ico_08" data-bind="{'active': pointMenu.activeType == 'spot','disabled': pointMenu.isEnabled(spot)}" href="{{host}}/scenic/{{scenicId}}/detail">景区概述</a>-->
</div>

</div>
<div style="display: none">
    <div class="marker-list" data-bind="foreach:markers">
        <div class="marker" data-bind="click:$root.showtip">
            <i class="point"></i>
            <div class="tip" data-bind="attr:{id:'tip_'+id}">
                <div class="tip-title">
                    <h3 data-bind="text:name"></h3>

                </div>
                <div class="tip-content" data-bind="text:remark"></div>
                <div class="tip-bottom">
                    <ul>
                        <li ><a data-bind="attr:{href:url}">
                            <i class="fa fa-info-circle fa-lg" style="    color: #1d9d74;
    margin-right: 5px;"></i><span>查看详情</span>
                            </a></li>
                        <li ><a data-bind="attr:{href:'map_address.html?id=' + id+'&wid='+$root.params().wid+'&type=scenic&uselocale=true'}">
                            <i class="fa fa-map-marker fa-lg" style="    color: #1d9d74;
    margin-right: 5px;"></i><span>去这里</span></a></li>
                    </ul>
                </div>

            </div>
        </div>
    </div>


</div>

<script src="http://cdn.leafletjs.com/leaflet-1.0.0-b1/leaflet.js"></script>

<script src="js/L.Control.Locate.min.js"></script>
    <script src="js/bouncemarker.js"></script>
    <script src="../../scripts/jquery/zepto.min.js"></script>
<script src="../../scripts/knockout/knockout-3.3.0.js"></script>

    <script type="text/javascript">
        var ViewModel = function(params) {
            var self = this;
            this.params=ko.observable(params);
            this.map=ko.observable();
            this.mapborder=ko.observable();
            this.markers = ko.observableArray();
            this.statusbox={text:ko.observable('亲，你不在景区内，赶紧去景区试试吧！'),show:ko.observable(false),close:function(){
                self.statusbox.show(false);

            }};
            this.pointMenu={
                show:ko.observable(false),
                activeType:ko.observable('spot'),
                isEnabled:{
                    spot:ko.observable(true),
                    eat:ko.observable(true),
                    hotel:ko.observable(true),
                    wc:ko.observable(false),
                    shop:ko.observable(false),
                    show:ko.observable(false),
                    help:ko.observable(false),
                    wifi:ko.observable(false)

                },
                showTag:function(type){
                    if(self.pointMenu.isEnabled[type]())
                    {
                        self.pointMenu.activeType(type);
                    }
                    var wid=self.params().wid;
                    switch (type)
                    {
                        case 'spot':
                            self.jumpUrl('poilist.html?type=scenic&wid=' + wid);
                            break;
                        case 'hotel':
                            self.jumpUrl('poilist.html?type=hotel&wid=' + wid);
                            break;
                        case 'eat':
                            self.jumpUrl('poilist.html?type=catering&wid=' + wid);
                            break;
                    }
                }
            };

            this.init=function(){
                self.initmap(40.0625, 116.34375);
//                self.initmap(39.99530029296875, 116.35028839111328);
           //     self.initmap(39.99530029296875, 116.35028839111328);
                self.addlocation();//添加定位服务
                var imageurl="http://www.cloudorg.com.cn/weixin/map/images/map.jpg";
//                self.addScenicLayer(imageurl);//添加景区图层
                self.addtileLayer();//添加缩放图层
                self.bindevent();//添加绑定事件

                this.loadData();
            };

            this.initmap=function(lat,lng)
            {
                var mapMinZoom = 3;
                var mapMaxZoom = 5;
                var map = L.map('map', {
                    maxZoom: mapMaxZoom,
                    minZoom: mapMinZoom,
                    attributionControl: false,
                    crs: L.CRS.Simple
                });
                var mapsize = self.getMapSize();
//                var _mapCenter =map.unproject([mapsize.width/2,mapsize.height/2], mapMaxZoom);
//                var _mapCenter =map.unproject([3146,3034], mapMaxZoom);
                var _mapCenter =map.unproject([1612,1462], mapMaxZoom);
                map.setView(_mapCenter, mapMinZoom+1);
                self.map(map);

            };
            this.getMapSize=function(){
                return { height: 6068/2, width: 8858/2 };
            };
            this.getborderlatlng = function() {
                return { lat: 39.99848, lng: 116.3469 };
            };
            this.addlocation=function(){
                L.control.locate({
                    drawCircle:false,
                    showPopup:false,
                    onLocationError: function(err) {
                        self.statusbox.text('亲，定位出错了！');
                        self.statusbox.show(true);
                    },  // define an error callback function
                    onLocationOutsideMapBounds:  function(context) { // called when outside map boundaries
                        self.statusbox.text('亲，你不在景区内，赶紧去景区试试吧！');
                        self.statusbox.show(true);
                    },
                }).addTo(self.map());
            };
            this.addtileLayer=function(){
                var map=self.map();
                var mapsize = self.getMapSize();
//                var latlng = self.getborderlatlng();
                var mapMinZoom = map.getMinZoom();
                var mapMaxZoom = map.getMaxZoom();
                var mapBounds;
                if(! self.mapborder())
                {
                    var southWest = map.unproject([0, mapsize.height], map.getMaxZoom());
                    var northEast = map.unproject([mapsize.width, 0], map.getMaxZoom());


                    //移动地图到景区
//                    southWest.lat += latlng.lat;
//                    southWest.lng += latlng.lng;
//                    northEast.lat += latlng.lat;
//                    northEast.lng += latlng.lng;
                     mapBounds = new L.LatLngBounds(southWest, northEast);
                    self.setborder(mapBounds);
                }
                else
                {
                    mapBounds=self.mapborder();
                }
                L.tileLayer('images/map/{z}/{x}/{y}.png', {
                    minZoom: mapMinZoom, maxZoom: mapMaxZoom,
                    bounds: mapBounds,
//                    attribution: 'Rendered with <a href="http://www.maptiler.com/">MapTiler</a>',
                    noWrap: true
                }).addTo(map);
//                L.tileLayer('images/map/{z}/{x}/{y}.png', {
//                    minZoom: mapMinZoom, maxZoom: mapMaxZoom,
//                    bounds: mapBounds,
//                   // attribution: '由 <a href="https://twitter.com/jxiaox">jxiaox</a>提供',
//                    noWrap: true
//                }).addTo(map);


            };
            this.addScenicLayer=function(imageurl){

                var map=self.map();
                var mapsize = self.getMapSize();
                var latlng = self.getborderlatlng();


                var southWest = map.unproject([0, mapsize.height], map.getMaxZoom());
                var northEast = map.unproject([mapsize.width, 0], map.getMaxZoom());

//                //移动地图到景区
//                southWest.lat += latlng.lat;
//                southWest.lng += latlng.lng;
//                northEast.lat += latlng.lat;
//                northEast.lng += latlng.lng;

                var bounds = new L.LatLngBounds(southWest, northEast);
                self.mapborder(bounds);
                self.setborder(bounds);
                 new L.ImageOverlay(imageurl, bounds).addTo(map);
            };
            this.setborder=function(bounds){
                var map=self.map();
                map.setMaxBounds(bounds);
                //阻止拖出边界
                map.on('drag', function() {
                    map.panInsideBounds(bounds, { animate: true });
                });
            };
            this.bindevent=function(){
                var map=self.map();
                map
                        .on('zoom', function(event) {
                            console.log("map zoom :", event);
                        })
                        .on("locationfound", function(event) {

                            console.log("locationfound :", event);
                        })
                        .on("locationerror", function(event) {

                            console.log("locationerror :", event);
                        })
                        .on("popupopen", function(spot) {
                            console.log(spot);

                            //修改地图包样式.  这并不完美..

                                setTimeout(function(){
                                    $('.leaflet-popup-tip').addClass('has_point_detail');
                                }, 200);

                        })
                        .on('click', function(event) {
                            var map=self.map();


                            console.log("map click :", event);
                            var point=map.project(event.latlng);
                            console.log(point);
                            console.log(event.containerPoint);

//                            var marker = L.marker([latlng.lat,latlng.lng]).addTo(map);
                        });
            };



            this.loadData = function() {
                $.ajax({
                    url: '/WebServices/MapWebService.asmx/GetMarkers',
                    dataType: "json",
                    data: { wid: self.params().wid },
                    success: function(res) {
                        if (res.isSuccess) {
                            self.markers(res.data);
                            self.addmarkers();

                        } else {
                            console.log(res.message);
                        }
                    }
                });
            };



            self.view = function(marker) {
                document.location.href = marker.url;
            };
            self.goto = function(marker) {
                document.location.href = 'map_address.html?id=' + marker.id;
            };
            self.addmarkers=function(){
                var map=self.map();
                for(var i=0;i<self.markers().length;i++)
                {
                    var data=self.markers()[i];
                    var latlng= map.unproject( [data.left, data.top], map.getMaxZoom());
                  var marker = L.marker(latlng,{
                      bounceOnAdd: true,
                      bounceOnAddOptions: {duration:400*(i+1)+500, height: 100},
                      bounceOnAddCallback: function() {console.log("done");}
                  }).addTo(map);
                    marker.on('click', function (e) {
                        e.target.bounce({ height: 100});
                    });

//                    var marker = L.marker(self.getLatLng(data.left,data.top)).addTo(map);
                    var popup=self.getPopup(data.id);
                    marker.bindPopup(popup);
                }
            };
            self.getPopup=function(id){
                var content=$('#tip_'+id).html();
                var popup=new L.popup({
                    className:'tip',
                    closeButton:false
                });
                popup.setContent(content);
                return popup;
            };
            self.getLatLng= function(x,y){
                return self._XYToLatLng(x,y);
            };
            self._XYToLatLng= function(x,y){
                if(x instanceof  Array)
                    y = x[1],x = x[0];
//                var OE.Scenic.originalZoom=10;
                var originalZoom = 10 * 1.0;
                var maxSize = Math.pow(2,originalZoom+8) * 1.0;
                var mapsize = self.getMapSize(),
                        lat =  (y * mapsize.height  + (maxSize - mapsize.height)/2)/maxSize,
                        lng =  (x * mapsize.width  + (maxSize - mapsize.width)/2)/maxSize;
                return [-256 * lat,256 * lng];
            };
            self.togglemenu=function(){
                self.pointMenu.show(!self.pointMenu.show());

            };
            self.jumpUrl=function(url){
                document.location.href=url;
            };

            this.init();

        };


    </script>


<script>
    var params={wid:0};
    $(function () {
        $('.content').scrollTop(100);
        $('.content').scrollLeft(400);
        var wid=getQueryString('wid');
        if(wid)
        {
            params.wid=wid;
        }

        var viewModel = new ViewModel(params);
        ko.applyBindings(viewModel);
    });
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return (r[2]);
        return null;
    }

</script>
</body>
</html>
